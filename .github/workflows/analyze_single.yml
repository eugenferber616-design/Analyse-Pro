name: Analyze watchlist (Template)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  batch:
    runs-on: ubuntu-latest
    env:
      WATCHLIST: watchlists/mylist.txt
      OUTDIR: data/processed/eq_template
      SITE_OUT: site/eq
      PUBLIC_BASE: ${{ vars.CF_R2_PUBLIC_BASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pandas yfinance requests python-dateutil
          sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure folders
        run: |
          mkdir -p "$OUTDIR" "$SITE_OUT" site

      - name: Build symbol list from watchlist
        id: make_list
        shell: bash
        run: |
          set -euo pipefail
          SYMLIST="symbols.list"
          tail -n +2 "$WATCHLIST" | cut -d',' -f1 | tr -d '\r' | awk 'NF>0' > "$SYMLIST"
          echo "SYMLIST=$SYMLIST" >> "$GITHUB_ENV"
          echo "Preview:"; head -n 20 "$SYMLIST" || true

      - name: Loop watchlist and render
        env:
          FINNHUB_TOKEN:   ${{ secrets.FINNHUB_TOKEN }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          SEC_USER_AGENT:  ${{ secrets.SEC_USER_AGENT }}
          PUBLIC_BASE:     ${{ env.PUBLIC_BASE }}
        shell: bash
        run: |
          set -euo pipefail
          INDEX_JSON="$OUTDIR/index.json"
          echo "[]" > "$INDEX_JSON"

          n=0
          while read -r SYM; do
            [ -z "$SYM" ] && continue
            echo "== Build $SYM =="

            python scripts/analyze_equity_template.py \
              --symbol "$SYM" \
              --out-json "$OUTDIR/${SYM}.json" \
              --out-html "$SITE_OUT/${SYM}.html" \
              --public-base "${PUBLIC_BASE:-https://pub-CHANGE-ME.r2.dev}" || true

            gzip -f -9 "$OUTDIR/${SYM}.json" || true

            # index.json mit jq erweitern
            tmp="$(mktemp)"
            jq --arg s "$SYM" '
              . + [{"symbol":$s,"json":($s+".json.gz"),"html":($s+".html")}]
              | sort_by(.symbol)
            ' "$INDEX_JSON" > "$tmp"
            mv "$tmp" "$INDEX_JSON"

            n=$((n+1))
          done < "$SYMLIST"

          echo "Anzahl gerenderter Symbole: $n"
          gzip -f -9 "$INDEX_JSON" || true

          # ── einfache Indexseite (korrektes Here-Doc) ──
          cat > site/index.html << 'HTML'
<!doctype html><meta charset="utf-8">
<title>Equity Templates</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;padding:24px;background:#0f1116;color:#e6e6e6}
a{color:#7bd4ff;text-decoration:none}a:hover{text-decoration:underline}
.card{max-width:900px;margin:0 auto}
h1{margin:0 0 8px 0}.muted{color:#9aa4ad}
ul{columns:3;gap:24px}li{margin:6px 0}
</style>
<div class="card">
  <h1>Equity Templates</h1>
  <div class="muted">Ticker aus der Watchlist</div>
  <ul>
HTML
          awk '{print "    <li><a href=\"eq/"$0".html\">" $0 "</a></li>"}' "$SYMLIST" >> site/index.html
          echo "  </ul>"  >> site/index.html
          echo "</div>"   >> site/index.html

      - name: Upload to R2 (analysis-pro bucket)
        env:
          CF_R2_ACCESS_KEY_ID:     ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          CF_R2_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          CF_R2_BUCKET:            ${{ secrets.CF_R2_BUCKET }}
          CF_R2_ENDPOINT:          ${{ secrets.CF_R2_ENDPOINT }}
        shell: bash
        run: |
          set -e
          if [ -z "${CF_R2_ACCESS_KEY_ID}" ] || [ -z "${CF_R2_SECRET_ACCESS_KEY}" ] || \
             [ -z "${CF_R2_ENDPOINT}" ] || [ -z "${CF_R2_BUCKET}" ]; then
            echo "R2 Secrets fehlen → Upload übersprungen."
            exit 0
          fi
          curl -fsSL https://rclone.org/install.sh | sudo bash
          cat > rclone.conf <<EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${CF_R2_ACCESS_KEY_ID}
          secret_access_key = ${CF_R2_SECRET_ACCESS_KEY}
          endpoint = ${CF_R2_ENDPOINT}
          force_path_style = true
          no_check_bucket = true
          EOF
          rclone copy "$OUTDIR"   "r2:${CF_R2_BUCKET}/analysis/eq_template" --config rclone.conf --s3-no-check-bucket -v
          rclone copy "$SITE_OUT" "r2:${CF_R2_BUCKET}/site/eq"               --config rclone.conf --s3-no-check-bucket -v
          rclone copy site/index.html "r2:${CF_R2_BUCKET}/site"              --config rclone.conf --s3-no-check-bucket -v

      - name: Commit small artifacts
        shell: bash
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add site/index.html || true
          git commit -m "Add Equity Templates index (site/index.html)" || echo "Nothing to commit"
          git push || true

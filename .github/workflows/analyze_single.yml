# .github/workflows/analyze_watchlist.yml
name: Analyze watchlist (Template)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  batch:
    runs-on: ubuntu-latest
    env:
      WATCHLIST: watchlists/mylist.txt
      OUTDIR: data/processed/eq_template
      SITE_OUT: site/eq
      PUBLIC_BASE: ${{ vars.CF_R2_PUBLIC_BASE }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pandas yfinance requests python-dateutil
      - name: Ensure folders
        run: mkdir -p "$OUTDIR" "$SITE_OUT" site
      - name: Loop watchlist and render
        env:
          FINNHUB_TOKEN:   ${{ secrets.FINNHUB_TOKEN }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          SEC_USER_AGENT:  ${{ secrets.SEC_USER_AGENT }}
        shell: bash
        run: |
          # erste Spalte = Symbol, Header Ã¼berspringen
          tail -n +2 "$WATCHLIST" | cut -d',' -f1 | tr -d '\r' | while read -r SYM; do
            [ -z "$SYM" ] && continue
            echo "== Build $SYM =="
            python scripts/analyze_equity_template.py \
              --symbol "$SYM" \
              --out-json "$OUTDIR/${SYM}.json" \
              --out-html "$SITE_OUT/${SYM}.html" \
              --public-base "${PUBLIC_BASE:-https://pub-CHANGE-ME.r2.dev}" || true
            gzip -f -9 "$OUTDIR/${SYM}.json" || true
          done
          echo "<!doctype html><meta charset='utf-8'><meta http-equiv='refresh' content='0; url=eq/${SYM}.html'>" > site/index.html
      - name: Upload to R2
        if: ${{ secrets.CF_R2_BUCKET != '' }}
        env:
          CF_R2_ACCESS_KEY_ID:     ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          CF_R2_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          CF_R2_BUCKET:            ${{ secrets.CF_R2_BUCKET }}
          CF_R2_ENDPOINT:          ${{ secrets.CF_R2_ENDPOINT }}
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          cat > rclone.conf <<EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${CF_R2_ACCESS_KEY_ID}
          secret_access_key = ${CF_R2_SECRET_ACCESS_KEY}
          endpoint = ${CF_R2_ENDPOINT}
          force_path_style = true
          no_check_bucket = true
          EOF
          rclone copy "data/processed/eq_template" "r2:${CF_R2_BUCKET}/analysis/eq_template" --config rclone.conf --s3-no-check-bucket -v
          rclone copy "site/eq"                     "r2:${CF_R2_BUCKET}/site/eq"            --config rclone.conf --s3-no-check-bucket -v
          rclone copy site/index.html               "r2:${CF_R2_BUCKET}/site"               --config rclone.conf --s3-no-check-bucket -v

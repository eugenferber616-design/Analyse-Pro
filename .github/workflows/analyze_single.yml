# .github/workflows/analyze_single.yml
name: Analyze equities (Template, single or watchlist)

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Optional: einzelnes Symbol (z.B. AAPL). Leer = Watchlist benutzen."
        type: string
        required: false
      limit:
        description: "Optional: nur die ersten N Symbole verarbeiten (zum Testen)"
        type: number
        required: false

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    env:
      # Pfade
      WATCHLIST: watchlists/mylist.txt
      OUTDIR:    data/processed/eq_template
      SITE_OUT:  site/eq
      PUBLIC_BASE: ${{ vars.CF_R2_PUBLIC_BASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pandas yfinance requests python-dateutil

      - name: Ensure folders
        run: |
          mkdir -p "$OUTDIR" "$SITE_OUT" site

      - name: Build symbol list (SYMLIST)
        id: syms
        shell: bash
        run: |
          set -e
          SYMLIST=/tmp/symlist.txt
          : > "$SYMLIST"

          if [ -n "${{ github.event.inputs.symbol }}" ]; then
            echo "${{ github.event.inputs.symbol }}" | tr -d '\r' >> "$SYMLIST"
          else
            if [ -f "$WATCHLIST" ]; then
              # 1. Spalte = Symbol (Header "symbol" o.ä. wird übersprungen)
              tail -n +2 "$WATCHLIST" | cut -d',' -f1 | tr -d '\r' | awk 'NF>0' >> "$SYMLIST"
            else
              echo "Watchlist nicht gefunden: $WATCHLIST" >&2
              exit 1
            fi
          fi

          # ggf. limit
          if [ -n "${{ github.event.inputs.limit }}" ] && [ "${{ github.event.inputs.limit }}" -gt 0 ]; then
            head -n "${{ github.event.inputs.limit }}" "$SYMLIST" > /tmp/symlist_limited.txt
            mv /tmp/symlist_limited.txt "$SYMLIST"
          fi

          echo "SYMLIST=$SYMLIST" >> "$GITHUB_ENV"
          echo "count=$(wc -l < "$SYMLIST" | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Render templates (JSON + HTML) for each symbol
        env:
          FINNHUB_TOKEN:   ${{ secrets.FINNHUB_TOKEN }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          SEC_USER_AGENT:  ${{ secrets.SEC_USER_AGENT }}
        shell: bash
        run: |
          set -e
          n=0
          while IFS= read -r SYM; do
            [ -z "$SYM" ] && continue
            SYM=$(echo "$SYM" | tr -d '\r')
            echo "== Build $SYM =="
            python scripts/analyze_equity_template.py \
              --symbol "$SYM" \
              --out-json "$OUTDIR/${SYM}.json" \
              --out-html "$SITE_OUT/${SYM}.html" \
              --public-base "${PUBLIC_BASE:-https://pub-CHANGE-ME.r2.dev}" || true
            gzip -f -9 "$OUTDIR/${SYM}.json" || true
            n=$((n+1))
          done < "$SYMLIST"
          echo "Gerenderte Symbole: $n"

      - name: Build JSON index (eq_index.json)
        shell: bash
        run: |
          set -e
          INDEX_JSON=site/eq_index.json
          python - "$INDEX_JSON" "$SYMLIST" << 'PY'
          import sys, json, pathlib
          out, lst = sys.argv[1], sys.argv[2]
          syms = [s.strip() for s in open(lst, 'r', encoding='utf-8').read().splitlines() if s.strip()]
          data = [{"symbol": s, "json": f"data/processed/eq_template/{s}.json.gz", "html": f"site/eq/{s}.html"} for s in syms]
          pathlib.Path(out).write_text(json.dumps(sorted(data, key=lambda x: x["symbol"]), indent=2), encoding="utf-8")
          PY

      - name: Build index.html
        shell: bash
        run: |
          set -e
          # statisches Gerüst
          cat > site/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <title>Equity Templates</title>
          <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
          <style>
          body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;padding:24px;background:#0f1116;color:#e6e6e6}
          a{color:#7bd4ff;text-decoration:none}a:hover{text-decoration:underline}
          .card{max-width:900px;margin:0 auto}
          h1{margin:0 0 8px 0}.muted{color:#9aa4ad}
          ul{columns:3;gap:24px}li{margin:6px 0}
          </style>
          <div class="card">
            <h1>Equity Templates</h1>
            <div class="muted">Ticker aus der Watchlist</div>
            <ul>
          HTML

          # Liste der Links einfügen
          awk '{print "  <li><a href=\"eq/"$0".html\">" $0 "</a></li>"}' "$SYMLIST" >> site/index.html

          # schließen
          echo "  </ul>"   >> site/index.html
          echo "</div>"    >> site/index.html

      - name: Upload to R2 (analysis-pro bucket)
        if: ${{ secrets.CF_R2_BUCKET != '' && secrets.CF_R2_ENDPOINT != '' && secrets.CF_R2_ACCESS_KEY_ID != '' && secrets.CF_R2_SECRET_ACCESS_KEY != '' }}
        env:
          CF_R2_ACCESS_KEY_ID:     ${{ secrets.CF_R2_ACCESS_KEY_ID }}
          CF_R2_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY }}
          CF_R2_BUCKET:            ${{ secrets.CF_R2_BUCKET }}
          CF_R2_ENDPOINT:          ${{ secrets.CF_R2_ENDPOINT }}
        shell: bash
        run: |
          set -e
          curl -fsSL https://rclone.org/install.sh | sudo bash
          cat > rclone.conf <<EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${CF_R2_ACCESS_KEY_ID}
          secret_access_key = ${CF_R2_SECRET_ACCESS_KEY}
          endpoint = ${CF_R2_ENDPOINT}
          force_path_style = true
          no_check_bucket = true
          EOF
          rclone copy "data/processed/eq_template" "r2:${CF_R2_BUCKET}/data/processed/eq_template" --config rclone.conf --s3-no-check-bucket -v
          rclone copy "site/eq"                     "r2:${CF_R2_BUCKET}/site/eq"                      --config rclone.conf --s3-no-check-bucket -v
          rclone copy "site/index.html"             "r2:${CF_R2_BUCKET}/site"                         --config rclone.conf --s3-no-check-bucket -v
          rclone copy "site/eq_index.json"          "r2:${CF_R2_BUCKET}/site"                         --config rclone.conf --s3-no-check-bucket -v

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eq-template-site
          path: |
            site/**
            data/processed/eq_template/**

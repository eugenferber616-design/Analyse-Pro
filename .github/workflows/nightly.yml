- name: Diagnose forkast secrets & bucket (forcast)
  env:
    CF_R2_ACCESS_KEY_ID:     ${{ secrets.CF_R2_ACCESS_KEY_ID_FORKAST }}
    CF_R2_SECRET_ACCESS_KEY: ${{ secrets.CF_R2_SECRET_ACCESS_KEY_FORKAST }}
    CF_R2_BUCKET:            ${{ secrets.CF_R2_BUCKET_FORKAST }}   # forcast
    CF_R2_ENDPOINT:          ${{ secrets.CF_R2_ENDPOINT_FORKAST }}
  shell: bash
  run: |
    set +e  # <- nicht abbrechen, wir fangen Fehler selbst ab
    for k in CF_R2_ACCESS_KEY_ID CF_R2_SECRET_ACCESS_KEY CF_R2_BUCKET CF_R2_ENDPOINT; do
      if [ -n "${!k}" ]; then echo "$k=SET"; else echo "$k=EMPTY"; fi
    done

    curl -fsSL https://rclone.org/install.sh | sudo bash

    cat > rclone.conf <<EOF
    [r2f]
    type = s3
    provider = Cloudflare
    access_key_id = ${CF_R2_ACCESS_KEY_ID}
    secret_access_key = ${CF_R2_SECRET_ACCESS_KEY}
    endpoint = ${CF_R2_ENDPOINT}
    force_path_style = true
    no_check_bucket = true
    EOF

    echo "== Try list prefix (can fail with bucket-scoped tokens) =="
    rclone --config rclone.conf --s3-no-check-bucket lsf "r2f:${CF_R2_BUCKET}/" || echo "(ignored)"

    echo "== Write test object to verify permissions =="
    echo "ok $(date -u)" > /tmp/health.txt
    if rclone --config rclone.conf --s3-no-check-bucket copy /tmp/health.txt "r2f:${CF_R2_BUCKET}/prompter/health.txt"; then
      echo "WRITE SUCCESS to r2f:${CF_R2_BUCKET}/prompter/health.txt"
      exit 0
    else
      echo "WRITE FAILED â€“ check endpoint/bucket/keys"
      exit 0  # Diagnose darf den Job nicht hart failen
    fi
